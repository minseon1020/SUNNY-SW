// src/pages/Dashboard.jsx
import { useState, useEffect } from "react";
import "./Dashboard.css";
import MapKorea from "../components/MapKorea";
import ChartSection from "../components/ChartSection";

function Dashboard() {
  // â”€â”€ ìƒíƒœ
  const [selectedRegion, setSelectedRegion] = useState(null);
  const [selectedRegionData, setSelectedRegionData] = useState([]);
  const [sidoTotalData, setSidoTotalData] = useState([]);
  const [energyType, setEnergyType] = useState("electric"); // âš¡/ğŸ”¥ (ì°¨íŠ¸ìš©)
  const [mainTab, setMainTab] = useState("energy");
  const [energyData, setEnergyData] = useState([]);        // ì „êµ­ ì›”ë³„ í•©ê³„(ì°¨íŠ¸ìš©)
  const [mapEnergyData, setMapEnergyData] = useState([]);  // â­ ì§€ë„ìš© ì‹œêµ°êµ¬ ìƒì„¸ ë°ì´í„°
  const [loading, setLoading] = useState(true);

  // ì§€ë„ìš©ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¬ ì‹œ/ë„ ì½”ë“œ (geojsonì´ë‘ ë§ì¶°ì„œ)
  const SIDO_CODES = [
    "11", "26", "27", "28", "29",
    "30", "31", "36",
    "41", "42", "43", "44", "45", "46", "47", "48",
    "50",
  ];

  /** âœ… 1) ì „êµ­ ë°ì´í„° ë¡œë“œ (ì „êµ­ ì›”ë³„ í•©ê³„ â€” ì°¨íŠ¸ìš©) */
  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        setEnergyData([]);

        const res = await fetch("/api/energy?cityId=0&countyId=0");
        const json = await res.json();

        const nationwide = Array.isArray(json?.items)
          ? json.items
          : Array.isArray(json)
          ? json
          : [];

        console.log("[Dashboard] nationwide sample:", nationwide.slice(0, 10));
        setEnergyData(nationwide);
        setSelectedRegionData(nationwide); // ì „êµ­ ê¸°ë³¸ ì°¨íŠ¸
      } catch (err) {
        console.error("ì „ì²´ ì—ë„ˆì§€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  /** âœ… 2) ì§€ë„ìš© ë°ì´í„° ë¡œë“œ (ì‹œ/ë„ë³„ ì‹œêµ°êµ¬ ìƒì„¸ ë°ì´í„° ëª¨ì•„ì„œ í•œ ë²ˆì—)
   *  ë°±ì—”ë“œ ì•ˆ ê±´ë“œë¦¬ê³  /api/energy?cityId=11,26,27... ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œí•´ì„œ í•©ì¹¨
   */
  useEffect(() => {
    (async () => {
      try {
        const requests = SIDO_CODES.map((code) =>
          fetch(`/api/energy?cityId=${code}`).then((r) => r.json())
        );

        const results = await Promise.all(requests);

        const all = [];
        results.forEach((json, idx) => {
          const arr = Array.isArray(json?.items)
            ? json.items
            : Array.isArray(json)
            ? json
            : [];
          console.log(
            `[Dashboard] mapEnergyData ì‹œë„=${SIDO_CODES[idx]} ê°œìˆ˜=`,
            arr.length
          );
          all.push(...arr);
        });

        console.log("[Dashboard] mapEnergyData ì´ ê°œìˆ˜:", all.length);
        setMapEnergyData(all);
      } catch (err) {
        console.error("ì§€ë„ìš© ì—ë„ˆì§€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
      }
    })();
  }, []); // ì²˜ìŒ í•œ ë²ˆë§Œ

  /** ====================================================================================
   *  3) ì§€ë„ í´ë¦­ ì‹œ ì§€ì—­ë³„ ë°ì´í„° ë¡œë“œ + ì‹œë„ í‰ê·  ë¡œë“œ (ì°¨íŠ¸ìš©, ê¸°ì¡´ ë¡œì§ ìœ ì§€)
   * ==================================================================================== */
  useEffect(() => {
    if (!selectedRegion) {
      setSelectedRegionData(energyData);
      setSidoTotalData([]);
      return;
    }

    let url = "/api/energy";
    const cityId = Number(selectedRegion.cityId);
    const countyId = Number(selectedRegion.countyId);

    if (cityId && countyId) {
      url += `?cityId=${cityId}&countyId=${countyId}`;
    } else if (cityId) {
      url += `?cityId=${cityId}`;
    }

    (async () => {
      try {
        const res = await fetch(url);
        const json = await res.json();

        const dataArray = Array.isArray(json?.items)
          ? json.items
          : Array.isArray(json)
          ? json
          : [];

        setSelectedRegionData(dataArray);

        // ì‹œë„ í‰ê·  ë°ì´í„°
        if (cityId) {
          const sidoRes = await fetch(
            `/api/energy?cityId=${cityId}&countyId=0`
          );
          const sidoJson = await sidoRes.json();

          const sidoArr = Array.isArray(sidoJson?.items)
            ? sidoJson.items
            : Array.isArray(sidoJson)
            ? sidoJson
            : [];

          setSidoTotalData(sidoArr);
        } else {
          setSidoTotalData([]);
        }
      } catch (err) {
        console.error("ì„ íƒ ì§€ì—­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
      }
    })();
  }, [selectedRegion, energyData]);

  // ë¡œë”© í™”ë©´
  if (loading) {
    return (
      <div className="dashboard">
        <h1>ì—ë„ˆì§€ ì •ë³´ ëŒ€ì‹œë³´ë“œ</h1>
        <p>ğŸ“¡ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    );
  }

  return (
    <div className="dashboard">
      <h1>ì—ë„ˆì§€ ì •ë³´ ëŒ€ì‹œë³´ë“œ</h1>
      <p>ì¢…í•© ì—ë„ˆì§€ ë°ì´í„°, ì‚¬ìš©ëŸ‰ ì¶”ì´, ì˜ˆì¸¡ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” ì—ë„ˆì§€ ì •ë³´ ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.</p>

      <div className="dashboard-grid">
        {/* ì§€ë„ */}
        <div className="card map">
          <h3>ì§€ì—­ë³„ ì—ë„ˆì§€ ì†Œë¹„ëŸ‰ (2025ë…„ 6ì›” ê¸°ì¤€)</h3>
          <div className="panel-body" style={{ height: 500 }}>
            <MapKorea
              onRegionSelect={setSelectedRegion}
              allEnergyData={mapEnergyData}   // â­ ì§€ë„ëŠ” ìƒì„¸ ë°ì´í„° ì‚¬ìš©
              yearMonth="202506"              // â­ 2025ë…„ 6ì›”ë§Œ íˆíŠ¸ë§µ
            />
          </div>
        </div>

        {/* ì°¨íŠ¸ */}
        <div className="card chart">
          <h3>
            {selectedRegion
              ? `${selectedRegion.cityName || ""} ${
                  selectedRegion.countyName || ""
                }`.trim()
              : "ì „êµ­ ì—ë„ˆì§€ / íƒ„ì†Œ ë°°ì¶œëŸ‰"}
          </h3>

          <div className="main-tabs">
            <button
              className={mainTab === "energy" ? "active" : ""}
              onClick={() => setMainTab("energy")}
            >
              ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰
            </button>
            <button
              className={mainTab === "co2" ? "active" : ""}
              onClick={() => setMainTab("co2")}
            >
              íƒ„ì†Œ ë°°ì¶œëŸ‰
            </button>
          </div>

          <div className="sub-tabs">
            <button
              className={energyType === "electric" ? "active" : ""}
              onClick={() => setEnergyType("electric")}
            >
              âš¡ ì „ê¸°
            </button>
            <button
              className={energyType === "gas" ? "active" : ""}
              onClick={() => setEnergyType("gas")}
            >
              ğŸ”¥ ê°€ìŠ¤
            </button>
          </div>

          <ChartSection
            selectedRegion={selectedRegion}
            selectedRegionData={selectedRegionData}
            nationalData={energyData}
            sidoData={sidoTotalData}   // ì‹œë„ í‰ê·  ë°ì´í„°
            energyType={energyType}
            mainTab={mainTab}
          />
        </div>

        {/* ì˜ˆì¸¡ ì¹´ë“œ */}
        <div className="card chart">
          <h3>~2030 ì—ë„ˆì§€ ì˜ˆì¸¡ ì‹œë‚˜ë¦¬ì˜¤</h3>
          <div className="chart-placeholder">ğŸ“ˆ ì˜ˆì¸¡ ê·¸ë˜í”„ ìë¦¬</div>
        </div>

        <div className="card chart">
          <h3>~2030 ê¸°ìƒì²­ ì˜¨ë„ ì˜ˆì¸¡</h3>
          <div className="chart-placeholder">ğŸŒ¡ ì˜ˆì¸¡ ê·¸ë˜í”„ ìë¦¬</div>
        </div>
      </div>
    </div>
  );
}

export default Dashboard;
