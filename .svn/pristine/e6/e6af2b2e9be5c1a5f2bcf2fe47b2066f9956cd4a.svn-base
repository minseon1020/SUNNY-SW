// src/pages/Dashboard.jsx
// ëŒ€ì‹œë³´ë“œ ê¸°ë³¸ í˜ì´ì§€(ë³‘í•©ë³¸): ì§€ë„ + ê·¸ë˜í”„ 4ê°œ + íƒ­/ë°ì´í„° ì—°ë™

import { useState, useEffect } from "react";
import "./Dashboard.css";
import MapKorea from "../components/MapKorea";
import ChartSection from "../components/ChartSection";

function Dashboard() {
  // â”€â”€ ìƒíƒœ
  const [selectedRegion, setSelectedRegion] = useState(null);     
  const [selectedRegionData, setSelectedRegionData] = useState([]); 
  const [sidoTotalData, setSidoTotalData] = useState([]);   // â˜… ì¶”ê°€: ì‹œêµ°êµ¬ í´ë¦­ ì‹œ ë¹„êµìš© ì‹œë„ ì „ì²´ ë°ì´í„°
  const [energyType, setEnergyType] = useState("electric");       
  const [mainTab, setMainTab] = useState("energy");               
  const [energyData, setEnergyData] = useState([]);               
  const [loading, setLoading] = useState(true);

  /** âœ… 1) ì „êµ­ ë°ì´í„° ë¡œë“œ */
  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        setEnergyData([]);

        const res = await fetch("/api/energy?cityId=0&countyId=0");
        if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
        const json = await res.json();
//        const nationwide = Array.isArray(json) ? json : [json]; ë¬¸ì œì 
		console.log("ìˆ˜ì •!");
		const nationwide = Array.isArray(json?.items)
		  ? json.items
		  : Array.isArray(json)
		  ? json
		  : [];
		  
		  
        setEnergyData(nationwide);

        // â˜… ì¶”ê°€ â€” ì²« í™”ë©´ì—ì„œ ì „êµ­ ì°¨íŠ¸ ë³´ì´ë„ë¡
        setSelectedRegionData(nationwide);

      } catch (err) {
        console.error("ì „ì²´ ì—ë„ˆì§€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  /** âœ… 2) ì§€ë„ í´ë¦­ ì‹œ ì§€ì—­ë³„ ë°ì´í„° ë¡œë“œ */
  useEffect(() => {

    // â˜… ì „êµ­ ì„ íƒ ì‹œ â†’ ì „êµ­ ë°ì´í„° ê·¸ëŒ€ë¡œ ì‚¬ìš©
    if (!selectedRegion) {
      setSelectedRegionData(energyData);
      setSidoTotalData([]); // ì‹œë„ ë¹„êµì„  ì—†ìŒ
      return;
    }

    let url = "/api/energy";
    const cityId = Number(selectedRegion.cityId);
    const countyId = Number(selectedRegion.countyId);

    if (cityId && countyId) url += `?cityId=${cityId}&countyId=${countyId}`;
    else if (cityId) url += `?cityId=${cityId}`;

    (async () => {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨");
        const json = await res.json();

        const dataArray = Array.isArray(json?.items)
          ? json.items
          : Array.isArray(json)
          ? json
          : [];

        setSelectedRegionData(dataArray);   // ì‹œë„ or ì‹œêµ°êµ¬ ë°ì´í„° ì €ì¥
        console.log("âœ… ì‹¤ì œ ì°¨íŠ¸ìš© ë°ì´í„°:", dataArray);

        // --------------------------------------------------
        // â˜… ì¶”ê°€: ì‹œêµ°êµ¬ í´ë¦­í•œ ê²½ìš° â†’ ì‹œë„ ì „ì²´ ë°ì´í„°ë„ í•¨ê»˜ ë¶ˆëŸ¬ì˜¤ê¸°
        // --------------------------------------------------
        if (cityId && countyId) {
          const sidoRes = await fetch(`/api/energy?cityId=${cityId}&countyId=0`);
          const sidoJson = await sidoRes.json();
          const sidoArr = Array.isArray(sidoJson?.items)
            ? sidoJson.items
            : Array.isArray(sidoJson)
            ? sidoJson
            : [];

          setSidoTotalData(sidoArr);
        } else {
          // ì‹œë„ í´ë¦­ ì‹œ â†’ ë¹„êµëŠ” ì „êµ­ì´ë¯€ë¡œ sidoTotalData í•„ìš” ì—†ìŒ
          setSidoTotalData([]);
        }
      } catch (err) {
        console.error("ì„ íƒ ì§€ì—­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
      }
    })();
  }, [selectedRegion, energyData]);

  // ë¡œë”© ë·°
  if (loading) {
    return (
      <div className="dashboard">
        <h1>ì—ë„ˆì§€ ì •ë³´ ëŒ€ì‹œë³´ë“œ</h1>
        <p>ğŸ“¡ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    );
  }

  return (
    <div className="dashboard">
      {/* ì œëª©/ì„¤ëª… */}
      <h1>ì—ë„ˆì§€ ì •ë³´ ëŒ€ì‹œë³´ë“œ</h1>
      <p>
        ì¢…í•© ì—ë„ˆì§€ ë°ì´í„°, ì‚¬ìš©ëŸ‰ ì¶”ì´, ì˜ˆì¸¡ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” ì—ë„ˆì§€ ì •ë³´ ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.
      </p>

      {/* 2x2 ì¹´ë“œí˜• ë°°ì¹˜ */}
      <div className="dashboard-grid">

        {/* ì§€ë„ */}
        <div className="card map">
          <h3>ì§€ì—­ë³„ ì—ë„ˆì§€ ì†Œë¹„ëŸ‰</h3>
          <div className="panel-body" style={{ height: 500 }}>
            <MapKorea
              onRegionSelect={setSelectedRegion}
              energyType={energyType}
              allEnergyData={energyData}
            />
          </div>
        </div>

        {/* ìƒì„¸ ì°¨íŠ¸ */}
        <div className="card chart">
          <h3>
            {selectedRegion
              ? `${selectedRegion.cityName || ""} ${selectedRegion.countyName || ""}`.trim()
              : "ì „êµ­ ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰"}
          </h3>

          {/* ìƒë‹¨ íƒ­ */}
          <div className="main-tabs">
            <button className={mainTab === "energy" ? "active" : ""} onClick={() => setMainTab("energy")}>
              ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰
            </button>
            <button className={mainTab === "co2" ? "active" : ""} onClick={() => setMainTab("co2")}>
              íƒ„ì†Œ ë°°ì¶œëŸ‰
            </button>
          </div>

          {/* í•˜ìœ„ íƒ­ */}
          <div className="sub-tabs">
            <button className={energyType === "electric" ? "active" : ""} onClick={() => setEnergyType("electric")}>
              âš¡ ì „ê¸°
            </button>
            <button className={energyType === "gas" ? "active" : ""} onClick={() => setEnergyType("gas")}>
              ğŸ”¥ ê°€ìŠ¤
            </button>
          </div>

          {/* ì°¨íŠ¸ ì„¹ì…˜ */}
          <ChartSection
            selectedRegion={selectedRegion}
            selectedRegionData={selectedRegionData}
            nationalData={energyData}      // â˜… ì „êµ­ ë¹„êµ ë°ì´í„°
            sidoData={sidoTotalData}       // â˜… ì‹œë„ ë¹„êµ ë°ì´í„°
            energyType={energyType}
            mainTab={mainTab}
          />
        </div>

        {/* ì˜ˆì¸¡ ì¹´ë“œë“¤ */}
        <div className="card chart">
          <h3>~2030 ì—ë„ˆì§€ ì˜ˆì¸¡ ì‹œë‚˜ë¦¬ì˜¤</h3>
          <div className="chart-placeholder">ğŸ“ˆ ì˜ˆì¸¡ ê·¸ë˜í”„ ìë¦¬</div>
        </div>

        <div className="card chart">
          <h3>~2030 ê¸°ìƒì²­ ì˜¨ë„ ì˜ˆì¸¡</h3>
          <div className="chart-placeholder">ğŸŒ¡ ì˜ˆì¸¡ ê·¸ë˜í”„ ìë¦¬</div>
        </div>

      </div>
    </div>
  );
}

export default Dashboard;
