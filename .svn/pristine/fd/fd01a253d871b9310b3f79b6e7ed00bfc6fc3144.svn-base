import { useEffect, useRef } from "react";
import Chart from "chart.js/auto";

export default function ChartSection({
  selectedRegion,
  selectedRegionData,
  energyType,
  mainTab,
}) {
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  useEffect(() => {
    if (!selectedRegion || !selectedRegionData || selectedRegionData.length === 0) return;

    // âœ… ë°ì´í„° êµ¬ì¡° ì •ë¦¬
    const rawData = selectedRegionData.items || selectedRegionData;

    // âœ… 1. 2020~2025.06 ì‚¬ì´ ë°ì´í„°ë§Œ ì‚¬ìš©
    const cleanData = rawData.filter((d) => {
      const ym = Number(d.yearMonth);
      return ym >= 202001 && ym <= 202506;
    });
    if (cleanData.length === 0) return;

    // âœ… 2. ì „ì²´ ì›” ë¦¬ìŠ¤íŠ¸ ìƒì„±
    const allMonths = [];
    for (let y = 2020; y <= 2025; y++) {
      for (let m = 1; m <= 12; m++) {
        const ym = `${y}${String(m).padStart(2, "0")}`;
        allMonths.push(ym);
        if (ym === "202506") break;
      }
    }

    // âœ… 3. ê³µí†µ í•¨ìˆ˜ (ê°’ ì„ íƒ)
    const getVal = (d) =>
      energyType === "electric" ? Number(d.useElect || 0) : Number(d.useGas || 0);

    let labels = [];
    let values = [];

    // âœ… 4. ì‹œë„ í´ë¦­ â†’ ì‹œêµ°êµ¬ í‰ê·  ê³„ì‚°
    if (!selectedRegion.countyId) {
      const countySet = new Set();
      cleanData.forEach((d) => {
        if (d.countyId != null) countySet.add(Number(d.countyId));
      });
      const countyIds = Array.from(countySet);

      // ì‹œêµ°êµ¬ë³„ë¡œ yearMonthë³„ ê°’ ì €ì¥
      const countyDataMap = new Map();
      countyIds.forEach((id) => countyDataMap.set(id, new Map()));

      cleanData.forEach((d) => {
        const cId = Number(d.countyId);
        if (!countyDataMap.has(cId)) countyDataMap.set(cId, new Map());
        countyDataMap.get(cId).set(d.yearMonth, getVal(d));
      });

      // ì›”ë³„ í‰ê·  ê³„ì‚° (ë¹„ì–´ìˆëŠ” ì›”ì€ 0 í¬í•¨)
      labels = allMonths;
      values = labels.map((ym) => {
        let total = 0;
        let count = 0;
        countyIds.forEach((id) => {
          const val = countyDataMap.get(id)?.get(ym) ?? 0;
          total += val;
          count += 1;
        });
        return count > 0 ? total / count : 0;
      });
    } else {
      // âœ… 5. ì‹œêµ°êµ¬ í´ë¦­ â†’ ê°œë³„ ê·¸ë˜í”„
      const myData = new Map();
      cleanData.forEach((d) => {
        if (Number(d.countyId) === Number(selectedRegion.countyId)) {
          myData.set(d.yearMonth, getVal(d));
        }
      });
      labels = allMonths;
      values = labels.map((ym) => myData.get(ym) ?? 0);
    }

    // âœ… ê¸°ì¡´ ì°¨íŠ¸ ì œê±° í›„ ìƒˆë¡œ ê·¸ë¦¼
    if (chartInstance.current) chartInstance.current.destroy();
    const ctx = chartRef.current.getContext("2d");

    // âœ… 6. ì°¨íŠ¸ ìƒì„±
    chartInstance.current = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label:
              energyType === "electric"
                ? selectedRegion.countyId
                  ? "ì „ê¸° ì‚¬ìš©ëŸ‰ (MWh)"
                  : "ì „ê¸° ì‚¬ìš©ëŸ‰ í‰ê·  (MWh)"
                : selectedRegion.countyId
                ? "ê°€ìŠ¤ ì‚¬ìš©ëŸ‰ (ì²œã¥)"
                : "ê°€ìŠ¤ ì‚¬ìš©ëŸ‰ í‰ê·  (ì²œã¥)",
            data: values,
            borderColor: energyType === "electric" ? "#3b82f6" : "#f97316",
            backgroundColor:
              energyType === "electric" ? "#3b82f633" : "#f9731633",
            fill: true,
            tension: 0.35,
            borderWidth: 2,
            pointRadius: 2,
            pointHoverRadius: 4,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: (context) =>
                `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`,
            },
          },
          legend: {
            display: true,
            position: "top",
            labels: { boxWidth: 14, color: "#333", font: { size: 13 } },
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: (v) => v.toLocaleString() },
          },
          x: {
            ticks: { autoSkip: true, maxTicksLimit: 8 },
          },
        },
      },
    });
  }, [selectedRegion, selectedRegionData, energyType, mainTab]);

  // âœ… ì„ íƒ ì „ ì•ˆë‚´ ë¬¸êµ¬
  if (!selectedRegion) {
    return (
      <div
        style={{
          width: "100%",
          height: "420px",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          color: "#888",
        }}
      >
        ğŸ“ ì™¼ìª½ ì§€ë„ì—ì„œ ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
      </div>
    );
  }

  return (
    <div style={{ width: "100%", height: "420px", paddingTop: "8px" }}>
      <canvas ref={chartRef} style={{ width: "100%", height: "100%" }} />
    </div>
  );
}
