import { useEffect, useRef } from "react";
import Chart from "chart.js/auto";

export default function ChartSection({
  selectedRegion,
  selectedRegionData,
  nationalData,
  sidoData,
  energyType,
  mainTab,
}) {
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  useEffect(() => {

    if (!selectedRegionData || selectedRegionData.length === 0) return;

    // === ê¸°ì¡´ ì½”ë“œ ìœ ì§€ ===
    const rawData = selectedRegionData.items || selectedRegionData;

    const cleanData = rawData.filter((d) => {
      const ym = Number(d.yearMonth);
      return ym >= 202001 && ym <= 202506;
    });

    if (cleanData.length === 0) return;

    // === ì›” ë¦¬ìŠ¤íŠ¸ ===
    const allMonths = [];
    for (let y = 2020; y <= 2025; y++) {
      for (let m = 1; m <= 12; m++) {
        const ym = `${y}${String(m).padStart(2, "0")}`;
        allMonths.push(ym);
        if (ym === "202506") break;
      }
    }

    const getVal = (d) =>
      energyType === "electric" ? Number(d.useElect || 0) : Number(d.useGas || 0);

    let labels = allMonths;
    let values = [];
    let compareValues = [];

    // ==================================================
    // 1) ë©”ì¸ ë°ì´í„° ê³„ì‚° (í‰ê·  X â†’ ëª¨ë‘ í•©ê³„ ê¸°ì¤€)
    // ==================================================

    // ðŸ”µ ì „êµ­ ì„ íƒ
    if (!selectedRegion) {
      const map = new Map();
      (nationalData || []).forEach((d) => map.set(d.yearMonth, getVal(d)));
      values = labels.map((ym) => map.get(ym) ?? 0);
    }

    // ðŸ”µ ì‹œë„ ì„ íƒ (ì‹œêµ°êµ¬ ê°’ í•©ì‚°í•´ì„œ â€œì‹œë„ ì „ì²´ í•©ê³„â€)
    else if (!selectedRegion.countyId) {
      const countyMap = {};

      cleanData.forEach((d) => {
        if (!countyMap[d.countyId]) countyMap[d.countyId] = {};
        countyMap[d.countyId][d.yearMonth] = getVal(d);
      });

      values = labels.map((ym) => {
        let total = 0;
        Object.values(countyMap).forEach((m) => {
          total += m[ym] ?? 0;
        });
        return total;
      });
    }

    // ðŸ”µ ì‹œêµ°êµ¬ ì„ íƒ (ë‹¨ì¼ ê°’)
    else {
      const map = new Map();
      cleanData.forEach((d) => {
        if (Number(d.countyId) === Number(selectedRegion.countyId)) {
          map.set(d.yearMonth, getVal(d));
        }
      });
      values = labels.map((ym) => map.get(ym) ?? 0);
    }

    // ==================================================
    // 2) ë¹„êµì„  ê³„ì‚° (ì „ì²´ í•©ê³„ ê¸°ì¤€)
    // ==================================================

    // ì „êµ­ì€ ë¹„êµì„  ì—†ìŒ
    if (!selectedRegion) {
      compareValues = [];
    }

    // ì‹œë„ ì„ íƒ â†’ ë¹„êµì„  = ì „êµ­ ì „ì²´ í•©ê³„
    else if (!selectedRegion.countyId) {
      const natMap = new Map();
      (nationalData || []).forEach((d) => natMap.set(d.yearMonth, getVal(d)));
      compareValues = labels.map((ym) => natMap.get(ym) ?? 0);
    }

    // ì‹œêµ°êµ¬ ì„ íƒ â†’ ë¹„êµì„  = í•´ë‹¹ ì‹œë„ ì „ì²´ í•©ê³„
    else {
      const sidoMap = new Map();
      (sidoData || []).forEach((d) => sidoMap.set(d.yearMonth, getVal(d)));
      compareValues = labels.map((ym) => sidoMap.get(ym) ?? 0);
    }
    // ==================================================
    // 3) ì°¨íŠ¸ ìƒì„± (dual-axis ì ìš©)
    // ==================================================

    if (chartInstance.current) chartInstance.current.destroy();
    const ctx = chartRef.current.getContext("2d");

    const datasets = [
      {
        label:
          !selectedRegion
            ? "ì „êµ­ í•©ê³„"
            : selectedRegion.countyId
            ? `${selectedRegion.countyName}`
            : `${selectedRegion.cityName} ì „ì²´ í•©ê³„`,
        data: values,
        borderColor: "#3b82f6",
        backgroundColor: "#3b82f633",
        yAxisID: "y1",
        fill: true,
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 2,
      },
    ];

    if (compareValues.length > 0) {
      datasets.push({
        label:
          !selectedRegion.countyId
            ? "ì „êµ­ í•©ê³„"
            : `${selectedRegion.cityName} ì „ì²´ í•©ê³„`,
        data: compareValues,
        borderColor: "#ef4444",
        backgroundColor: "#ef444433",
        yAxisID: "y2",
        fill: false,
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 2,
      });
    }

    chartInstance.current = new Chart(ctx, {
      type: "line",
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y1: { type: "linear", position: "left" },
          y2: {
            type: "linear",
            position: "right",
            grid: { drawOnChartArea: false },
          },
        },
      },
    });
  }, [
    selectedRegion,
    selectedRegionData,
    nationalData,
    sidoData,
    energyType,
    mainTab,
  ]);

  return (
    <div style={{ width: "100%", height: "420px", paddingTop: "8px" }}>
      <canvas ref={chartRef} style={{ width: "100%", height: "100%" }} />
    </div>
  );
}
