// src/pages/Dashboard.jsx
import { useState, useEffect } from "react";
import "./Dashboard.css";
import MapKorea from "../components/MapKorea";
import ChartSection from "../components/ChartSection";

function Dashboard() {
  // â”€â”€ ìƒíƒœ
  const [selectedRegion, setSelectedRegion] = useState(null);
  const [selectedRegionData, setSelectedRegionData] = useState([]);
  const [sidoTotalData, setSidoTotalData] = useState([]);
  const [energyType, setEnergyType] = useState("electric");
  const [mainTab, setMainTab] = useState("energy");
  const [energyData, setEnergyData] = useState([]);
  const [loading, setLoading] = useState(true);

  /** âœ… 1) ì „êµ­ ë°ì´í„° ë¡œë“œ */
  useEffect(() => {
    (async () => {
      try {
        setLoading(true);
        setEnergyData([]);

        const res = await fetch("/api/energy?cityId=0&countyId=0");
        if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
        const json = await res.json();

        const nationwide = Array.isArray(json?.items)
          ? json.items
          : Array.isArray(json)
          ? json
          : [];

        setEnergyData(nationwide);
        setSelectedRegionData(nationwide); // ì „êµ­ ê¸°ë³¸ ì°¨íŠ¸

      } catch (err) {
        console.error("ì „ì²´ ì—ë„ˆì§€ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  /** âœ… 2025ë…„ 6ì›” ì‚¬ìš©ëŸ‰ë§Œ ì¶”ì¶œ â€” ì§€ë„ íˆíŠ¸ë§µìš© */
  const monthData = energyData.filter(
    (d) => String(d.yearMonth) === "202506"
  );

  /** ====================================================================================
   *  âœ… 2) ì§€ë„ í´ë¦­ ì‹œ ì§€ì—­ë³„ ë°ì´í„° ë¡œë“œ + ì‹œë„ í‰ê·  ë¡œë“œ (í•µì‹¬ ìˆ˜ì • ì™„ë£Œ)
   * ==================================================================================== */
  useEffect(() => {
    if (!selectedRegion) {
      setSelectedRegionData(energyData);
      setSidoTotalData([]); // ì „êµ­ì€ ë¹„êµ ì—†ìŒ
      return;
    }

    let url = "/api/energy";
    const cityId = Number(selectedRegion.cityId);
    const countyId = Number(selectedRegion.countyId);

    if (cityId && countyId) {
      url += `?cityId=${cityId}&countyId=${countyId}`;
    } else if (cityId) {
      url += `?cityId=${cityId}`;
    }

    (async () => {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨");
        const json = await res.json();

        const dataArray = Array.isArray(json?.items)
          ? json.items
          : Array.isArray(json)
          ? json
          : [];

        setSelectedRegionData(dataArray);

        // ------------------------------------------------------
        // ğŸ”¥ í•µì‹¬: ì‹œë„ í´ë¦­ & ì‹œêµ°êµ¬ í´ë¦­ ëª¨ë‘ "ì‹œë„ ì „ì²´ í‰ê· "ì´ í•„ìš”í•¨
        // ------------------------------------------------------
        if (cityId) {
          const sidoRes = await fetch(`/api/energy?cityId=${cityId}&countyId=0`);
          const sidoJson = await sidoRes.json();
          const sidoArr = Array.isArray(sidoJson?.items)
            ? sidoJson.items
            : Array.isArray(sidoJson)
            ? sidoJson
            : [];

          setSidoTotalData(sidoArr); // â˜… ì‹œë„ ì „ì²´ ë°ì´í„° ì„¤ì •
        } else {
          setSidoTotalData([]); // ë°©ì–´ì  ì½”ë“œ
        }
      } catch (err) {
        console.error("ì„ íƒ ì§€ì—­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
      }
    })();
  }, [selectedRegion, energyData]);

  // ë¡œë”© í™”ë©´
  if (loading) {
    return (
      <div className="dashboard">
        <h1>ì—ë„ˆì§€ ì •ë³´ ëŒ€ì‹œë³´ë“œ</h1>
        <p>ğŸ“¡ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
    );
  }

  return (
    <div className="dashboard">
      <h1>ì—ë„ˆì§€ ì •ë³´ ëŒ€ì‹œë³´ë“œ</h1>
      <p>ì¢…í•© ì—ë„ˆì§€ ë°ì´í„°, ì‚¬ìš©ëŸ‰ ì¶”ì´, ì˜ˆì¸¡ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆëŠ” ì—ë„ˆì§€ ì •ë³´ ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.</p>

      <div className="dashboard-grid">
        
        {/* ì§€ë„ */}
        <div className="card map">
          <h3>ì§€ì—­ë³„ ì—ë„ˆì§€ ì†Œë¹„ëŸ‰</h3>
          <div className="panel-body" style={{ height: 500 }}>
            <MapKorea
              onRegionSelect={setSelectedRegion}
              energyType={energyType}
              allEnergyData={energyData}
              monthData={monthData}
            />
          </div>
        </div>

        {/* ì°¨íŠ¸ */}
        <div className="card chart">
          <h3>
            {selectedRegion
              ? `${selectedRegion.cityName || ""} ${selectedRegion.countyName || ""}`.trim()
              : "ì „êµ­ ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰"}
          </h3>

          <div className="main-tabs">
            <button className={mainTab === "energy" ? "active" : ""} onClick={() => setMainTab("energy")}>ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰</button>
            <button className={mainTab === "co2" ? "active" : ""} onClick={() => setMainTab("co2")}>íƒ„ì†Œ ë°°ì¶œëŸ‰</button>
          </div>

          <div className="sub-tabs">
            <button className={energyType === "electric" ? "active" : ""} onClick={() => setEnergyType("electric")}>âš¡ ì „ê¸°</button>
            <button className={energyType === "gas" ? "active" : ""} onClick={() => setEnergyType("gas")}>ğŸ”¥ ê°€ìŠ¤</button>
          </div>

          <ChartSection
            selectedRegion={selectedRegion}
            selectedRegionData={selectedRegionData}
            nationalData={energyData}
            sidoData={sidoTotalData}   // â˜… ì‹œë„ í‰ê· ìš© ë°ì´í„°
            energyType={energyType}
            mainTab={mainTab}
          />
        </div>

        {/* ì˜ˆì¸¡ ì¹´ë“œë“¤ */}
        <div className="card chart">
          <h3>~2030 ì—ë„ˆì§€ ì˜ˆì¸¡ ì‹œë‚˜ë¦¬ì˜¤</h3>
          <div className="chart-placeholder">ğŸ“ˆ ì˜ˆì¸¡ ê·¸ë˜í”„ ìë¦¬</div>
        </div>

        <div className="card chart">
          <h3>~2030 ê¸°ìƒì²­ ì˜¨ë„ ì˜ˆì¸¡</h3>
          <div className="chart-placeholder">ğŸŒ¡ ì˜ˆì¸¡ ê·¸ë˜í”„ ìë¦¬</div>
        </div>

      </div>
    </div>
  );
}

export default Dashboard;
