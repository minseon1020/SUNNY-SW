import { useEffect, useRef } from "react";
import Chart from "chart.js/auto";

// ----------------------------------------
// üìå Ïò®Ïã§Í∞ÄÏä§ Î∞∞Ï∂úÍ≥ÑÏàò (IPCC Í∏∞Ï§Ä ÏòàÏãú)
//  - Ï†ÑÍ∏∞Í≥ÑÏàò: 0.4541 tCO2/MWh
//  - ÎèÑÏãúÍ∞ÄÏä§ Í≥ÑÏàò: 0.202 tCO2/MWh
// ----------------------------------------
const ELEC_CO2_FACTOR = 0.4541;
const GAS_CO2_FACTOR = 0.202;

// ----------------------------------------
// üìå Í≥µÌÜµ ÏõîÎ≥Ñ ÌèâÍ∑† Í≥ÑÏÇ∞ (ÏãúÍµ∞Íµ¨ Í∞úÎ≥ÑÍ∞í Í∏∞Ï§Ä)
// ----------------------------------------
function makeMonthlyAverage(data, getVal, label = "UNKNOWN") {
  console.log(`\n===== [makeMonthlyAverage: ${label}] =====`);
  console.log(`‚ñ∂ ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞ Í∞úÏàò: ${data.length}`);

  const groups = {};

  data.forEach((d, idx) => {
    const ym = String(d.yearMonth).trim();
    const v = getVal(d);

    if (!groups[ym]) groups[ym] = [];
    groups[ym].push(v);

    if (idx < 5) {
      console.log(
        `  - sample[${idx}]: ym=${ym}, value=${v}, cityId=${d.cityId}, countyId=${d.countyId}`
      );
    }
  });

  console.log(`‚ñ∂ Í∑∏Î£πÌïëÎêú Ïõî Í∞úÏàò: ${Object.keys(groups).length}`);
  console.log(`‚ñ∂ Ïõî Î™©Î°ù(Ïïû 10Í∞ú):`, Object.keys(groups).slice(0, 10));

  const avg = {};

  Object.keys(groups)
    .sort()
    .forEach((ym) => {
      const arr = groups[ym];
      const monthlyAvg = arr.reduce((a, b) => a + b, 0) / arr.length;
      avg[ym] = monthlyAvg;

      console.log(
        `   ‚û§ ${label} | ${ym} | count=${arr.length} | sum=${arr.reduce(
          (a, b) => a + b,
          0
        )} | avg=${monthlyAvg}`
      );
    });

  console.log(`===== [END makeMonthlyAverage: ${label}] =====\n`);

  return avg;
}

// ----------------------------------------
// üìå Ï†ÑÍµ≠ ÌèâÍ∑† = Ï†ÑÍµ≠ ÏõîÎ≥ÑÌï©Í≥Ñ / Ï†ÑÍµ≠ ÏãúÍµ∞Íµ¨ Ïàò
// ----------------------------------------
function makeNationalSigunguAverage(nationalData, sigunguCount, getVal) {
  console.log("\n===== [makeNationalSigunguAverage ÏãúÏûë] =====");
  console.log("‚ñ∂ Ï†ÑÍµ≠ ÏãúÍµ∞Íµ¨ Ïàò:", sigunguCount);

  const natAvg = {};

  nationalData.forEach((d) => {
    const ym = String(d.yearMonth).trim();
    const total = getVal(d); // Ï†ÑÍµ≠ ÏõîÌï©Í≥Ñ (Ï†ÑÍ∏∞ or Í∞ÄÏä§ or CO2)

    natAvg[ym] = total / sigunguCount;

    console.log(
      `   ‚û§ Ï†ÑÍµ≠ÌèâÍ∑† | ${ym} | ÏõîÌï©=${total} / ${sigunguCount} = ${natAvg[ym]}`
    );
  });

  console.log("===== [END makeNationalSigunguAverage] =====\n");

  return natAvg;
}

// --------------------------------------------------------
//  üìå Main Component
// --------------------------------------------------------
export default function ChartSection({
  selectedRegion,
  selectedRegionData,
  nationalData, // 132Í±¥ = Ï†ÑÍµ≠ ÏõîÎ≥Ñ Ìï©Í≥Ñ Îç∞Ïù¥ÌÑ∞
  sidoData, // ÏãúÎèÑ Ï†ÑÏ≤¥ ÏãúÍµ∞Íµ¨ Îç∞Ïù¥ÌÑ∞(ÏàòÎ∞±~ÏàòÏ≤úÍ±¥)
  energyType, // 'electric' | 'gas'
  mainTab, // 'energy' | 'co2'
}) {
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  useEffect(() => {
    if (!selectedRegionData || selectedRegionData.length === 0) return;

    // ----------------------------
    // 1) ÌïÑÌÑ∞ÎßÅ
    // ----------------------------
    const raw = selectedRegionData.items || selectedRegionData;

    const clean = raw.filter((d) => {
      const ym = Number(String(d.yearMonth).trim());
      return ym >= 202001 && ym <= 202506;
    });

    if (clean.length === 0) return;

    // ‚òÖ Î™®Îì† Ïõî ÏÉùÏÑ±
    const labels = [];
    for (let y = 2020; y <= 2025; y++) {
      for (let m = 1; m <= 12; m++) {
        const ym = `${y}${String(m).padStart(2, "0")}`;
        labels.push(ym);
        if (ym === "202506") break;
      }
    }

    // ----------------------------
    // 2) Í∞í ÏÑ†ÌÉù Ìï®Ïàò (ÏóêÎÑàÏßÄ / CO2)
    // ----------------------------

    // ÏóêÎÑàÏßÄ ÏÇ¨Ïö©Îüâ (Í∏∞Ï°¥ Î°úÏßÅ Í∑∏ÎåÄÎ°ú)
    const getEnergyVal = (d) =>
      energyType === "electric"
        ? Number(d.useElect || 0)
        : Number(d.useGas || 0);

    // ÌÉÑÏÜåÎ∞∞Ï∂úÎüâ = ÏÇ¨Ïö©Îüâ √ó Î∞∞Ï∂úÍ≥ÑÏàò
    const getCo2Val = (d) => {
      const energy = getEnergyVal(d);
      const factor = energyType === "electric" ? ELEC_CO2_FACTOR : GAS_CO2_FACTOR;
      return energy * factor;
    };

    // mainTab Ïóê Îî∞Îùº Ïã§Ï†ú ÏÇ¨Ïö©ÌïòÎäî Ìï®Ïàò ÏÑ†ÌÉù
    const getVal = mainTab === "co2" ? getCo2Val : getEnergyVal;

    let values = [];
    let compareValues = [];

    // ==========================================================
    // 3) Ï†ÑÍµ≠ / ÏãúÎèÑ / ÏãúÍµ∞Íµ¨ Íµ¨Î∂ÑÌïòÏó¨ ÌèâÍ∑†Í≥ÑÏÇ∞
    // ==========================================================

    // ‚ë† Ï†ÑÍµ≠ ÏÑ†ÌÉù
    if (!selectedRegion) {
      const natAvg = makeMonthlyAverage(
        nationalData,
        getVal,
        mainTab === "co2" ? "Ï†ÑÍµ≠ CO2" : "Ï†ÑÍµ≠ ÏÇ¨Ïö©Îüâ"
      );
      values = labels.map((ym) => natAvg[ym] ?? 0);
      compareValues = []; // ÎπÑÍµê ÏóÜÏùå
    }

    // ‚ë° ÏãúÎèÑ ÏÑ†ÌÉù (countyId ÏóÜÏùå)
    else if (!selectedRegion.countyId) {
      // 2-1) ÏãúÎèÑ Ï†ÑÏ≤¥ ÌèâÍ∑†
      const sidoAvg = makeMonthlyAverage(
        sidoData,
        getVal,
        mainTab === "co2"
          ? `${selectedRegion.cityName} CO2`
          : `${selectedRegion.cityName} ÏÇ¨Ïö©Îüâ`
      );
      values = labels.map((ym) => sidoAvg[ym] ?? 0);

      // 2-2) Ï†ÑÍµ≠ ÏãúÍµ∞Íµ¨ Ïàò Í≥ÑÏÇ∞
      const sigunguCount = 253; // Í∏∞Î≥∏Í∞í

      // 2-3) Ï†ÑÍµ≠ ÏãúÍµ∞Íµ¨ ÌèâÍ∑†
      const natAvg = makeNationalSigunguAverage(
        nationalData,
        sigunguCount,
        getVal
      );
      compareValues = labels.map((ym) => natAvg[ym] ?? 0);
    }

    // ‚ë¢ ÏãúÍµ∞Íµ¨ ÏÑ†ÌÉù
    else {
      const countyId = Number(selectedRegion.countyId);

      // Í∞úÎ≥Ñ ÏãúÍµ∞Íµ¨ Í∞í
      const singleMap = {};
      clean.forEach((d) => {
        if (Number(d.countyId) === countyId) {
          singleMap[d.yearMonth] = getVal(d);
        }
      });
      values = labels.map((ym) => singleMap[ym] ?? 0);

      // ÏãúÎèÑ ÌèâÍ∑† ÎπÑÍµê
      const sidoAvg = makeMonthlyAverage(
        sidoData,
        getVal,
        mainTab === "co2"
          ? `${selectedRegion.cityName} CO2`
          : `${selectedRegion.cityName} ÏÇ¨Ïö©Îüâ`
      );
      compareValues = labels.map((ym) => sidoAvg[ym] ?? 0);
    }

    // ==========================================================
    // 4) Ï∞®Ìä∏ ÏÉùÏÑ±
    // ==========================================================
    if (chartInstance.current) chartInstance.current.destroy();
    const ctx = chartRef.current.getContext("2d");

    const baseLabel = !selectedRegion
      ? "Ï†ÑÍµ≠"
      : selectedRegion.countyId
      ? selectedRegion.countyName
      : selectedRegion.cityName;

    const unitLabel =
      mainTab === "co2"
        ? "ÌÉÑÏÜåÎ∞∞Ï∂úÎüâ"
        : energyType === "electric"
        ? "Ï†ÑÍ∏∞ ÏÇ¨Ïö©Îüâ"
        : "Í∞ÄÏä§ ÏÇ¨Ïö©Îüâ";

    const datasets = [
      {
        label: `${baseLabel} ${unitLabel}`,
        data: values,
        borderColor: "#3b82f6",
        backgroundColor: "#3b82f633",
        fill: true,
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 2,
      },
    ];

    if (compareValues.length > 0) {
      datasets.push({
        label: !selectedRegion
          ? ""
          : !selectedRegion.countyId
          ? `Ï†ÑÍµ≠ ÌèâÍ∑† ${unitLabel}`
          : `${selectedRegion.cityName} ÌèâÍ∑† ${unitLabel}`,
        data: compareValues,
        borderColor: "#ef4444",
        backgroundColor: "#ef444433",
        fill: false,
        tension: 0.3,
        borderWidth: 2,
        pointRadius: 2,
      });
    }

    chartInstance.current = new Chart(ctx, {
      type: "line",
      data: { labels, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
      },
    });
  }, [
    selectedRegion,
    selectedRegionData,
    nationalData,
    sidoData,
    energyType,
    mainTab,
  ]);

  return (
    <div style={{ width: "100%", height: "420px", paddingTop: "8px" }}>
      <canvas ref={chartRef} style={{ width: "100%", height: "100%" }} />
    </div>
  );
}
