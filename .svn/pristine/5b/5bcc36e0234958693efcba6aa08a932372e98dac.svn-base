// src/components/HeatBoxSimple.jsx
// ë‹¨ì¼ íŒŒì¼ íˆíŠ¸ë°•ìŠ¤(MapLibre heatmap) - CSV íŒŒì‹±ê¹Œì§€ ë‚´ë¶€ ì²˜ë¦¬

import { useEffect, useMemo, useRef, useState } from "react";
import { Map as ReactMap, Source, Layer, NavigationControl } from "react-map-gl";
import maplibregl from "maplibre-gl";
import "maplibre-gl/dist/maplibre-gl.css";
import Papa from "papaparse";

/* -------- ì‘ì€ ìŠ¤íƒ€ì¼(íŒŒì¼ ì¤„ì´ë ¤ê³  ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì— ì •ì˜) -------- */
const styles = `
.heatbox { display:flex; flex-direction:column; gap:10px; height:100%; }
.hb-top { display:flex; justify-content:space-between; gap:12px; align-items:center; }
.hb-left { display:flex; gap:8px; align-items:center; }
.hb-right { display:flex; gap:10px; align-items:center; }
.hb-btn { height:32px; padding:0 10px; border:1px solid #ddd; border-radius:8px; background:#fff; cursor:pointer; }
.hb-btn.ghost { background:#fafafa; }
.hb-field { font-size:14px; color:#333; display:inline-flex; gap:6px; align-items:center; }
.hb-legend { display:flex; gap:8px; align-items:center; font-size:12px; color:#666; }
.hb-legend i { display:inline-block; width:160px; height:10px; border-radius:999px; }
.hb-monthbar { display:flex; gap:4px; align-items:center; padding:8px 0; }
.hb-m { min-width:36px; height:28px; border:1px solid #e5e7eb; background:#fff; border-radius:6px; font-size:13px; cursor:pointer; }
.hb-m[disabled] { opacity:.35; cursor:not-allowed; }
.hb-m.active { background:#ffedd5; border-color:#fdba74; font-weight:700; }
.hb-warn { margin-top:6px; padding:10px 12px; border:1px solid #ffe58f; background:#fffbe6; border-radius:8px; color:#8b5e00; font-size:13px; }
`;

const pad2 = (n) => (n < 10 ? `0${n}` : String(n));
const onlyDigits = (s) => String(s ?? "").replace(/\D+/g, "");
const toYYYY_MM = (yyyymm) => `${yyyymm.slice(0, 4)}-${yyyymm.slice(4, 6)}`;

const norm = (s) =>
  String(s ?? "")
    .toLowerCase()
    .replace(/\([^)]*\)/g, "")
    .replace(/[^\wê°€-í£]+/g, " ")
    .replace(/\s+/g, "")
    .trim();

const CANDS = {
  ym:   ["ì‚¬ìš©ë…„ì›”","ê¸°ì¤€ë…„ì›”","ë…„ì›”","yyyymm","ym","month","ê¸°ê°„","ì—°ì›”","ì›”(yyyymm)"],
  sgg5: ["ì‹œêµ°êµ¬ì½”ë“œ","sigcd","sggcd","adm_drcd","adm_cd5","sig_cd5","code"],
  law10:["ë²•ì •ë™ì½”ë“œ","ë²•ì •ë™ì½”ë“œ10ìë¦¬","adm_cd","ë²•ì •ë™","ë²•ì •ì½”ë“œ","hid_cd"],
  elec: ["ì „ê¸°ì‚¬ìš©ëŸ‰","ì „ë ¥ì‚¬ìš©ëŸ‰","ì „ë ¥","ì „ë ¥ëŸ‰","electricity","mwh","elec"],
  gas:  ["ê°€ìŠ¤ì‚¬ìš©ëŸ‰","ë„ì‹œê°€ìŠ¤ì‚¬ìš©ëŸ‰","gas","gj","citygas","ê°€ìŠ¤"],
};
const detect = (headers, wants) => {
  const H = headers.map((h) => [h, norm(h)]);
  for (const w of wants) {
    const hit = H.find(([, n]) => n === norm(w));
    if (hit) return hit[0];
  }
  for (const w of wants) {
    const hit = H.find(([, n]) => n.includes(norm(w)));
    if (hit) return hit[0];
  }
  return null;
};

// Polygon/MultiPolygon â†’ bbox ì¤‘ì‹¬
function bboxCenter(geom) {
  const go = (coords, acc) => {
    for (const c of coords) {
      if (typeof c[0] === "number") {
        const [lng, lat] = c;
        acc.minX = Math.min(acc.minX, lng);
        acc.maxX = Math.max(acc.maxX, lng);
        acc.minY = Math.min(acc.minY, lat);
        acc.maxY = Math.max(acc.maxY, lat);
      } else go(c, acc);
    }
  };
  if (!geom) return null;
  const acc = { minX: 999, maxX: -999, minY: 999, maxY: -999 };
  if (geom.type === "Polygon") go(geom.coordinates, acc);
  else if (geom.type === "MultiPolygon") go(geom.coordinates, acc);
  else return null;
  return [(acc.minX + acc.maxX) / 2, (acc.minY + acc.maxY) / 2];
}

export default function HeatBoxSimple({
  csvUrl = "/ì „ì²´_ì—ë„ˆì§€_2020-2025_í†µí•©_v2.csv",
  sggGeoUrl = "/korea/sgg.json",

  // í•„ìš” ì‹œ ê°•ì œ ë§¤í•‘ í‚¤ (ë‹¨ìœ„ëŠ” ì œê±°ëœ í—¤ë”ëª…ì„ ê¶Œì¥: "ì „ê¸°ì‚¬ìš©ëŸ‰", "ê°€ìŠ¤ì‚¬ìš©ëŸ‰")
  forceYmKey, forceSggKey, forceElecKey, forceGasKey,

  autoPlay = true,
  intervalMs = 900,
}) {
  const [warn, setWarn] = useState("");
  const [metric, setMetric] = useState("elec"); // elec | gas
  const [normalize, setNormalize] = useState(true);

  const [months, setMonths] = useState([]); // ["YYYY-MM", ...]
  const [year, setYear] = useState("");
  const [idx, setIdx] = useState(0);
  const [playing, setPlaying] = useState(autoPlay);
  const [speed, setSpeed] = useState(1);

  const years = useMemo(() => Array.from(new Set(months.map(m => m.slice(0,4)))), [months]);
  const yearMonths = useMemo(() => (year ? months.filter(m => m.startsWith(year)) : []), [months, year]);
  const currentMonth = months[idx] || "-";

  // ì‹œêµ°êµ¬ code5 â†’ [lng,lat]
  const centersRef = useRef(new Map());
  // ym â†’ í¬ì¸íŠ¸ë“¤
  const bucketsRef = useRef({ elec: new Map(), gas: new Map() });
  
  const [centersReady, setCentersReady] = useState(false);
  // 1) ì‹œêµ°êµ¬ GeoJSON ë¡œë“œ â†’ ì¤‘ì‹¬ ê³„ì‚°
  useEffect(() => {
    (async () => {
      try {
        const r = await fetch(sggGeoUrl);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const gj = await r.json();
        const map = new Map();
        for (const f of gj.features || []) {
          const p = f.properties || {};
          const raw = p.SIG_CD ?? p.SGG_CD ?? p.ADM_DR_CD ?? p.code ?? p.sig_cd ?? p.sgg_cd;
          if (!raw) continue;
          const code5 = String(raw).padStart(5, "0").slice(0, 5);
          const center = bboxCenter(f.geometry);
          if (center) map.set(code5, center);
        }
        centersRef.current = map;
		setCentersReady(true);   // ğŸ”¥ state ë³€ê²½ â†’ CSV useEffect ì‹¤í–‰ ê°€ëŠ¥
        if (!map.size) setWarn("âš  sgg.jsonì—ì„œ ì¢Œí‘œë¥¼ ê³„ì‚°í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      } catch {
        setWarn("âš  /korea/sgg.json ë¡œë“œ ì‹¤íŒ¨");
      }
    })();
  }, [sggGeoUrl]);

  // 2) CSV ë¡œë“œ & íŒŒì‹±
  useEffect(() => {
	
	 if (!centersReady) {
	    console.log("â³ centers ì¤€ë¹„ ì „ â†’ CSV ëŒ€ê¸°");
	    return;
	 }
	  
	  
    (async () => {
      try {
        const res = await fetch(csvUrl, { cache: "no-cache" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        let text = await res.text();
        if (/<!doctype|<html/i.test(text.slice(0, 200))) {
          throw new Error("CSV_URL_RETURNED_HTML");
        }
        text = text.replace(/^\uFEFF/, ""); // BOM ì œê±°

        const parsed = Papa.parse(text, {
          header: true,
          skipEmptyLines: "greedy",
          dynamicTyping: true,
          transformHeader: (h) =>
            String(h).replace(/\([^)]*\)/g, "").replace(/\t/g, " ").replace(/\s+/g, " ").trim(),
        });
        const rows = Array.isArray(parsed.data) ? parsed.data : [];
        if (!rows.length) { setWarn("âš  CSVê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."); return; }

        const headers = parsed.meta.fields || Object.keys(rows[0]);
        const auto = {
          ymKey:   detect(headers, CANDS.ym),
          sgg5Key: detect(headers, CANDS.sgg5),
          law10Key: detect(headers, CANDS.law10),
          elecKey: detect(headers, CANDS.elec),
          gasKey:  detect(headers, CANDS.gas),
        };
        const ymKey   = forceYmKey  || auto.ymKey;
        const sgg5Key = forceSggKey || auto.sgg5Key || auto.law10Key; // ë²•ì •ë™ 10ìë¦¬ë„ í—ˆìš©
        const elecKey = forceElecKey|| auto.elecKey;
        const gasKey  = forceGasKey || auto.gasKey;

        if (!ymKey || !sgg5Key || (!elecKey && !gasKey)) {
          setWarn("âš  CSV í—¤ë” ë§¤í•‘ ì‹¤íŒ¨(ì‚¬ìš©ë…„ì›”/ì‹œêµ°êµ¬ì½”ë“œ/ì „ë ¥Â·ê°€ìŠ¤). propsë¡œ ê°•ì œ ë§¤í•‘í•˜ì„¸ìš”.");
          return;
        }

        // â€œ1,234â€ â†’ 1234
        const fixNum = (v) =>
          v == null || v === "" ? null :
          (typeof v === "number" ? v : Number(String(v).replace(/,/g, "")));

        const centers = centersRef.current;
        const elec = new Map(), gas = new Map(), ymSet = new Set();

        for (const r of rows) {
          const rawYM = r[ymKey];
          const dd = onlyDigits(String(rawYM ?? ""));
          if (dd.length < 6) continue;
          const ym = toYYYY_MM(dd.slice(0, 6));
          ymSet.add(ym);

          const code5 = onlyDigits(String(r[sgg5Key] ?? "")).slice(0, 5).padStart(5, "0");
          const ll = centers.get(code5);
          if (!ll) continue;

          const eVal = fixNum(r[elecKey]);
          const gVal = fixNum(r[gasKey]);

          if (Number.isFinite(eVal)) {
            if (!elec.has(ym)) elec.set(ym, []);
            elec.get(ym).push({ lng: ll[0], lat: ll[1], value: eVal });
          }
          if (Number.isFinite(gVal)) {
            if (!gas.has(ym)) gas.set(ym, []);
            gas.get(ym).push({ lng: ll[0], lat: ll[1], value: gVal });
          }
        }

        bucketsRef.current = { elec, gas };
        const ys = Array.from(ymSet).sort();
        setMonths(ys);
        setYear(ys[0]?.slice(0,4) || "");
        setIdx(0);
        setWarn(ys.length ? "" : "âš  CSVì—ì„œ ìœ íš¨í•œ ì›” ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      } catch (e) {
        console.error(e);
        setWarn("âš  CSV ë¡œë“œ/íŒŒì‹± ì‹¤íŒ¨");
      }
    })();
  }, [csvUrl, forceYmKey, forceSggKey, forceElecKey, forceGasKey, centersReady]);

  // 3) ìë™ì¬ìƒ
  useEffect(() => {
    if (!playing || yearMonths.length === 0) return;
    const arr = yearMonths;
    const cur = months[idx];
    const localIdx = Math.max(0, arr.indexOf(cur));
    const step = Math.max(150, intervalMs / (speed || 1));
    const timer = setInterval(() => {
      const nextLocal = (localIdx + 1) % arr.length;
      const nextYm = arr[nextLocal];
      const gi = months.findIndex((m) => m === nextYm);
      if (gi >= 0) setIdx(gi);
    }, step);
    return () => clearInterval(timer);
  }, [playing, yearMonths, months, idx, intervalMs, speed]);

  // 4) í˜„ì¬ ì›” â†’ GeoJSON(ì •ê·œí™”)
  const geojson = useMemo(() => {
    const src = bucketsRef.current[metric].get(currentMonth) || [];
    let maxV = 1;
    if (normalize && src.length) {
      maxV = src.reduce((m, d) => (d.value > m ? d.value : m), 0) || 1;
    }
    return {
      type: "FeatureCollection",
      features: src.map((d) => ({
        type: "Feature",
        geometry: { type: "Point", coordinates: [d.lng, d.lat] },
        properties: { w: normalize ? Math.max(0.05, d.value / maxV) : d.value },
      })),
    };
  }, [metric, normalize, currentMonth]);

  const heatPaint = useMemo(() => ({
    "heatmap-radius": [
      "interpolate", ["linear"], ["zoom"],
      5, 18, 7, 28, 10, 40
    ],
    "heatmap-intensity": 1.0,
    "heatmap-opacity": 0.9,
    "heatmap-weight": ["coalesce", ["get", "w"], 0],
    "heatmap-color": [
      "interpolate", ["linear"], ["heatmap-density"],
      0.0, "rgba(47,128,237,0)",
      0.2, "rgb(86,204,242)",
      0.4, "rgb(255,209,102)",
      0.6, "rgb(252,163,17)",
      1.0, "rgb(230,57,70)"
    ],
  }), []);

  const jumpTo = (m) => {
    if (!year) return;
    const ym = `${year}-${pad2(m)}`;
    const gi = months.findIndex((x) => x === ym);
    if (gi >= 0) setIdx(gi);
  };
//  const curMM = currentMonth !== "-" ? Number(currentMonth.slice(5, 7)) : 0;

  const monthHasData = useMemo(() => {
    const set = new Set(yearMonths);
    const has = {};
    for (let m = 1; m <= 12; m++) has[m] = set.has(`${year}-${pad2(m)}`);
    return has;
  }, [year, yearMonths]);

  return (
    <div className="heatbox" style={{ height: "100%" }}>
      {/* ì†Œê·œëª¨ ìŠ¤íƒ€ì¼ ì‚½ì… */}
      <style>{styles}</style>

      <div className="hb-top">
        <div className="hb-left">
          <button className="hb-btn" onClick={() => setPlaying(v=>!v)}>{playing ? "â¸ ì •ì§€" : "â–¶ ì¬ìƒ"}</button>
          <button className="hb-btn ghost" onClick={()=>{
            if (yearMonths.length === 0) return;
            const arr = yearMonths, local = Math.max(0, arr.indexOf(currentMonth));
            const prev = (local - 1 + arr.length) % arr.length;
            const ym = arr[prev];
            const gi = months.findIndex(m => m === ym);
            if (gi>=0) setIdx(gi);
          }}>â—€ ì´ì „</button>
          <button className="hb-btn ghost" onClick={()=>{
            if (yearMonths.length === 0) return;
            const arr = yearMonths, local = Math.max(0, arr.indexOf(currentMonth));
            const next = (local + 1) % arr.length;
            const ym = arr[next];
            const gi = months.findIndex(m => m === ym);
            if (gi>=0) setIdx(gi);
          }}>ë‹¤ìŒ â–¶</button>
          <span style={{fontWeight:700}}>{currentMonth}</span>
        </div>

        <div className="hb-right">
          <label className="hb-field">ì§€í‘œ
            <select value={metric} onChange={e => setMetric(e.target.value)}>
              <option value="elec">ì „ë ¥</option>
              <option value="gas">ê°€ìŠ¤</option>
            </select>
          </label>
          <label className="hb-field">ì •ê·œí™”
            <input type="checkbox" checked={normalize} onChange={e=>setNormalize(e.target.checked)}/>
          </label>
          <label className="hb-field">ì†ë„
            <select value={speed} onChange={e=>setSpeed(Number(e.target.value))}>
              <option value={0.5}>0.5x</option>
              <option value={1}>1x</option>
              <option value={2}>2x</option>
              <option value={3}>3x</option>
            </select>
          </label>
          <label className="hb-field">ì—°ë„
            <select value={year} onChange={(e)=>{
              setYear(e.target.value);
              const first = months.find(m => m.startsWith(e.target.value));
              if (first) setIdx(months.findIndex(m => m === first));
            }}>
              {years.map(y => <option key={y} value={y}>{y}</option>)}
            </select>
          </label>
        </div>
      </div>

      <div className="hb-legend">
        <span>ë‚®ìŒ</span>
        <i style={{background:"linear-gradient(90deg,#2f80ed,#56ccf2,#ffd166,#fca311,#e63946)"}}/>
        <span>ë†’ìŒ</span>
      </div>

      <div style={{ flex:1, minHeight:360 }}>
        <ReactMap
          mapLib={maplibregl}
          initialViewState={{ longitude: 127.8, latitude: 36.3, zoom: 6.2, minZoom: 5.8, maxZoom: 13 }}
          mapStyle="https://basemaps.cartocdn.com/gl/positron-gl-style/style.json"
          reuseMaps
          style={{ height:"100%", width:"100%" }}
        >
          <NavigationControl position="bottom-right" />
          <Source id="heat-src" type="geojson" data={geojson} />
          <Layer id="heat-lyr" type="heatmap" source="heat-src" paint={heatPaint} />
        </ReactMap>
      </div>

      <div className="hb-monthbar">
        <button className="hb-btn" onClick={()=>setPlaying(v=>!v)}>{playing ? "â¸" : "â–¶"}</button>
        {Array.from({ length: 12 }, (_, i) => i + 1).map((m) => {
          const has = monthHasData[m];
          const active = has && m === (currentMonth !== "-" ? Number(currentMonth.slice(5,7)) : 0) && currentMonth.startsWith(year);
          return (
            <button key={m} className={`hb-m ${active ? "active":""}`} disabled={!has} onClick={()=>jumpTo(m)} title={has?`${year}-${pad2(m)}`:"ë°ì´í„° ì—†ìŒ"}>
              {m}ì›”
            </button>
          );
        })}
      </div>

      {warn && <div className="hb-warn">{warn}</div>}
    </div>
  );
}
