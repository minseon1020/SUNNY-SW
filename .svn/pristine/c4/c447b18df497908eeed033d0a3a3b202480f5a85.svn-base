import React, { useState, useEffect } from 'react';
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer
} from 'recharts';

import Papa from 'papaparse';
import regionDistrictData from '../data/regionsData.json';

const yTickFormatter = (value) => {
  if (value === 0) return '0';
  return `${value / 1000000}MWh`;
};

const monthTableHeaders = [
  '지역 (구)', '1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'
];

function UsageStats() {
  
  // 날짜 범위 제한 로직 (기존과 동일)
  const minMonth = "2020-01";
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const maxMonth = `${yyyy}-${mm}`;

  const [selectedRegion, setSelectedRegion] = useState('11');
  const [selectedMonth, setSelectedMonth] = useState(maxMonth);
  const [allCsvData, setAllCsvData] = useState([]);
  const [displayTableData, setDisplayTableData] = useState([]);
  const [dynamicChartData, setDynamicChartData] = useState([]);
  const [yAxisMax, setYAxisMax] = useState(0);

  const [selectedEnergy, setSelectedEnergy] = useState('전기')

  useEffect(() => {
    fetch('/전체_에너지_2020-2025_통합_v2.csv')
      .then(response => response.text())
      .then(csvText => {
        Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (results) => {
            console.log('CSV 데이터 로드됨:', results.data[0]);
            setAllCsvData(results.data);
          }
        });
      })
      .catch(error => {
        console.error("CSV 파일 로딩 오류:", error);
      });
  }, []);

  const handleSearch = () => {
    if (allCsvData.length === 0 || !regionDistrictData[selectedRegion]) {
      setDisplayTableData([]);
      setDynamicChartData([]);
      setYAxisMax(0);
      return;
    }

    const targetYear = parseInt(selectedMonth.split('-')[0], 10);
    const yearStart = targetYear * 100 + 1;
    const yearEnd = targetYear * 100 + 12;

    const filteredCsvData = allCsvData.filter(row => 
      row.시도코드 == selectedRegion &&
      row.사용년월 >= yearStart &&
      row.사용년월 <= yearEnd
    );

    const monthlyTotals = new Array(12).fill(0);
    const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월']
    const dataMap = new Map();
    const tableMonthlyTotalsKWh = new Array(12).fill(0);

    const districtObject = regionDistrictData[selectedRegion].districts;

    Object.entries(districtObject).forEach(([guCode, guName]) => {
      dataMap.set(guCode, {
        gu: guName, 
        '1월': '-', '2월': '-', '3월': '-', '4월': '-', '5월': '-', '6월': '-',
        '7월': '-', '8월': '-', '9월': '-', '10월': '-', '11월': '-', '12월': '-'
      });
    });

    const isDataAvailableForChart = (selectedEnergy !== '전체');

    filteredCsvData.forEach(row => {
      const guCode = String(row.시군구코드).trim();
      const month = row.사용년월 % 100;
      const monthIndex = month - 1;
      const monthKey = `${month}월`;

      const electricUsage = row.전기사용량 || 0 / 1000;
      const gasUsage = row.가스사용량 || 0 / 1000;

      let usageWh;

      if (selectedEnergy === '전기') {
        usageWh = electricUsage;
      } else if (selectedEnergy === '가스') {
        usageWh = gasUsage;
      } else {
        usageWh = undefined;
      }

      if (isDataAvailableForChart && usageWh !== undefined && monthIndex >= 0 && monthIndex < 12) {
          monthlyTotals[monthIndex] += usageWh;
      }

      if (usageWh === undefined) return;

      const usageInKWh = Math.round(usageWh / 1000);

      if (dataMap.has(guCode)) {
        const guData = dataMap.get(guCode);
        if (!isNaN(usageInKWh)) {
          guData[monthKey] = usageInKWh;
          dataMap.set(guCode, guData);

          if (monthIndex >= 0 && monthIndex < 12) {
            tableMonthlyTotalsKWh[monthIndex] += usageInKWh;
          }
        }
      }
    });

    const maxUsage = Math.max(...monthlyTotals);
    const calculatedYMax = isDataAvailableForChart
        ? Math.ceil((maxUsage * 1.1) / 1000000) * 1000000
        : 1000000;

    const newChartData = monthNames.map((name, index) => ({
      name: name,
      사용량: monthlyTotals[index]
    }));

    setDynamicChartData(newChartData);
    setYAxisMax(calculatedYMax);

    const regionName = regionDistrictData[selectedRegion]
      ? regionDistrictData[selectedRegion].name
      : '';

    const totalRow = { gu: `${regionName} 전체` };
    monthNames.forEach((name, index) => {
      const totalKWh = tableMonthlyTotalsKWh[index];
      totalRow[name] = totalKWh > 0 ? totalKWh : '-';
    });

    setDisplayTableData([totalRow, ...Array.from(dataMap.values())]);
  };
  
  const handleRegionChange = (event) => {
    setSelectedRegion(event.target.value);
  };

  const renderTableContent = () => {
    if (!regionDistrictData[selectedRegion]) {
      return (
        <table className="stats-table">
          <thead>
            <tr>
              <th>날짜</th>
              <th>에너지원</th>
              <th>지역</th>
              <th>총 소비량(KWh)</th>
              <th>비용(원)</th>
              <th>효율성 등급</th>
              <th>추세</th>
            </tr>
          </thead>
          <tbody>
            {displayTableData.map((row) => (
              <tr key={row.date}>
                <td>{row.date}</td>
                <td>{row.energy}</td>
                <td>{row.region}</td>
                <td>{row.consumption}</td>
                <td>{row.cost}</td>
                <td>{row.efficiency}</td>
                <td>{row.trend}</td>
              </tr>
            ))}
          </tbody>
        </table>
      );
    }

    return (
      <table className="stats-table">
        <thead>
          <tr>
            {monthTableHeaders.map(header => (
              <th key={header}>{header}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {displayTableData.map((row, index) => (
            <tr 
              key={row.gu}
              style={{
                fontWeight: index === 0 ? 'bold' : 'normal',
                backgroundColor: index === 0 ? '#f9f9f9' : 'transparent'
              }}
            >
              <td>{row.gu}</td>
              {monthTableHeaders.slice(1).map(monthKey => (
                <td key={monthKey}>
                  {typeof row[monthKey] === 'number'
                    ? row[monthKey].toLocaleString()
                    : row[monthKey]}
                </td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    );
  };

  return (
    <div className="stats-sidebar-layout">
      
      {/* 9. 왼쪽 사이드바 */}
      <aside className="stats-sidebar">
        <div className="sidebar-section">
          <h4>날짜 범위 선택</h4>
          <input
            type="month"
            className="stats-input"
            min={minMonth}
            max={maxMonth}
            value={selectedMonth}
            onChange={(e) => setSelectedMonth(e.target.value)}
          />
        </div>
        
        <div className="sidebar-section">
          <h4>데이터 필터</h4>
          <label>에너지원</label>
          <select 
            className="stats-input"
            value={selectedEnergy}
            onChange={(e) => setSelectedEnergy(e.target.value)}
          >
            <option>전체</option>
            <option value="전기">전기에너지(MWh)</option>
            <option value="가스">가스에너지(MWh)</option>
          </select>
          <label>지역</label>
          {/* 4. [수정] select 태그에 state를 연결합니다. */}
          <select 
            className="stats-input"
            value={selectedRegion}
            onChange={handleRegionChange}
          >
            {Object.keys(regionDistrictData).map(regionCode => (
              <option key={regionCode} value={regionCode}>
                {regionDistrictData[regionCode].name}
              </option>
            ))}
          </select>
        </div>

        <div className="sidebar-section">
          <button className="stats-button-primary" onClick={handleSearch}>데이터 조회</button>
        </div>
      </aside>

      {/* 10. 오른쪽 메인 콘텐츠 */}
      <main className="main-content">
        <h2>에너지 사용량 통계</h2>

        {/* 11. 차트 섹션 */}
        <div className="chart-section">
          {/* ... (기존과 동일) ... */}
          <h3>월별 에너지 소비 추세</h3>
            <p>
              {regionDistrictData[selectedRegion] ? regionDistrictData[selectedRegion].name : '...'}의 {selectedMonth.split('-')[0]}년 {selectedEnergy === ' 전체' ? ' 에너지 데이터를 선택해 주세요.' : selectedEnergy + ' 소비량 변화를 보여줍니다'}
            </p>
          <div className="chart-container">
            <ResponsiveContainer width="100%" height={300}>
              <AreaChart
                data={dynamicChartData}
                margin={{ top : 30, right: 30, left: 50, bottom: 5}}
              >
                <CartesianGrid strokeDasharray="3 3"/>

                <XAxis
                  dataKey="name"
                  scale="point"
                  axisLine={false}
                  tickLine={false}
                  tick={{ fontSize: 13 }}
                />

                <YAxis
                  axisLine={false}
                  tickLine={false}
                  tickFormatter={yTickFormatter}
                  domain={[0, yAxisMax]}
                  tickCount={5}
                  tick={{ fontSize: 13 }}
                  label={{ value: '사용량(MWh)', position: 'top', offset: 17, fontWeight: "bold", fontSize: 14, fill: "#333"}}
                />
                
                <Tooltip
                  formatter={(value) => [`${(value / 1000).toLocaleString()} kWh`, '사용량']}
                />

                <Area
                  type="monotone"
                  dataKey="사용량"
                  stroke="#0088FE"
                  fill="#cce5ff"
                  strokeWidth={2}
                  activeDot={{ r: 6 }}
                  dot={{ r: 4, fill: '#0088FE' }}
                />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* 13. 테이블 섹션 */}
        <div className="table-section">
          <h3>
            {(!regionDistrictData[selectedRegion])
              ? '상세 에너지 소비 데이터'
              : `${regionDistrictData[selectedRegion].name} ${selectedMonth.split('-')[0]}년 구별 상세 데이터`
            }
          </h3>
          <p>선택된 필터에 따른 상세 에너지 소비 내역입니다.</p>
          <div className="stats-table-container">
            {renderTableContent()}
          </div>
        </div>
        
      </main>
    </div>
  );
}

export default UsageStats;